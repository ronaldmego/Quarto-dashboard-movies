---
title: "Películas en cartelera y estadísticas de tmdb.org"
format:
  dashboard:
    logo: "images/creator.png"
    orientation: columns
---

## Column {width="60%"}

```{r, loadpackages}
#| echo: false
#| include: false
library(tidyverse)
library(httr2)
library(gt)
```

```{r, codehttr2-credencialesocultas-good}
#| echo: false
#| include: false

token <- Sys.getenv("TMDB_TOKEN")

response <- httr2::request("https://api.themoviedb.org/3/movie/now_playing") |> 
  httr2::req_method("GET") |> 
  httr2::req_url_query(
    language = "en-US",
    page = "1",
  ) |> 
  httr2::req_headers(
    Authorization = paste0("Bearer ",token),
    accept = "application/json",
  ) |> 
  httr2::req_perform() |>
  httr2::resp_body_json()

# Extraer la lista de películas
movies_list <- response$results
```



```{r, creadataframe}
#| echo: false
#| include: false

# Convertir la lista de películas en un dataframe
movies_df <- tibble::tibble(
  original_title = sapply(movies_list, function(x) x$original_title),
  movie_id = sapply(movies_list, function(x) x$id),
  original_language = sapply(movies_list, function(x) x$original_language),
  release_date = sapply(movies_list, function(x) x$release_date),
  adult = sapply(movies_list, function(x) x$adult),
  popularity = sapply(movies_list, function(x) x$popularity),
  vote_average = sapply(movies_list, function(x) x$vote_average),
  vote_count = sapply(movies_list, function(x) x$vote_count),
  genre_ids = sapply(movies_list, function(x) x$genre_ids), # Añadir el campo genre_ids
  backdrop_path = sapply(movies_list, function(x) x$backdrop_path),
  poster_path = sapply(movies_list, function(x) x$poster_path),
  overview = sapply(movies_list, function(x) x$overview)
)

# Modificar la columna poster_path para tener la URL completa
movies_df <- movies_df %>%
  mutate(
    backdrop_url = paste0("https://image.tmdb.org/t/p/w780", backdrop_path),
    poster_url = paste0("https://image.tmdb.org/t/p/w500", poster_path),
    days_in_theaters = as.numeric(Sys.Date() - as.Date(release_date)) # Calcular días en cartelera
)
```



```{r, stars}
#| echo: false
#| include: false
generate_star_rating <- function(vote_averages) {
  sapply(vote_averages, function(vote_average) {
    vote_average <- round(as.numeric(vote_average), 1)  # Redondear a un decimal
    
    # Convertir de la escala de 0 a 10 a una escala de 0 a 5
    star_rating <- round(vote_average / 2, 1)
    
    # Obtener la parte entera y fraccionaria
    full_stars <- floor(star_rating)
    half_star <- ifelse(star_rating %% 1 >= 0.5, 1, 0)
    
    # Generar las estrellas llenas
    stars_html <- strrep('<span style="color: gold;">&#9733;</span>', full_stars)
    
    # Generar la media estrella si aplica
    if (half_star == 1) {
      stars_html <- paste0(stars_html, '<span style="color: gold;">&#9734;</span>')
    }
    
    # Completar con estrellas vacías
    empty_stars <- 5 - full_stars - half_star
    stars_html <- paste0(stars_html, strrep('<span style="color: #d3d3d3;">&#9733;</span>', empty_stars))
    
    # Incluir el número redondeado después de las estrellas
    stars_html <- paste0(stars_html, ' ', '<span style="font-size: 0.8em; color: white;">', vote_average, '</span>')
    
    return(stars_html)
  }, USE.NAMES = FALSE)
}
```


```{r, circular clock}
#| echo: false
#| include: false
# Determinar el valor máximo y mínimo de days_in_theaters en el dataset actual
max_days <- max(movies_df$days_in_theaters, na.rm = TRUE)
min_days <- min(movies_df$days_in_theaters, na.rm = TRUE)


generate_clock_svg <- function(days_in_theaters, max_days, min_days) {
  days_in_theaters <- as.numeric(days_in_theaters)
  
  # Escalar days_in_theaters en un rango de 0 a 360 grados
  angle <- ((days_in_theaters - min_days) / (max_days - min_days)) * 360
  
  # Calcular las coordenadas finales de la línea del reloj usando la escala de 360 grados
  radians <- pi * (angle / 360)
  x <- 25 + 20 * cos(radians)
  y <- 25 - 20 * sin(radians)
  
  # Invertir la lógica de colores: verde para pocos días, rojo para muchos días
  color <- ifelse(days_in_theaters < min_days + (max_days - min_days) * 0.2, "#1DB954", 
                  ifelse(days_in_theaters < min_days + (max_days - min_days) * 0.5, "#EDDE11", "#ED8E11"))
  
  # Generar el código SVG para el reloj circular
  svg_code <- sprintf(
    '<svg height="50" width="50">
      <circle cx="25" cy="25" r="20" stroke="black" stroke-width="2" fill="%1$s" />
      <line x1="25" y1="25" x2="%2$s" y2="%3$s" stroke="black" stroke-width="2" />
      <text x="25" y="25" font-size="12" text-anchor="middle" dy=".3em" fill="black">%4$s</text>
    </svg>',
    color, x, y, days_in_theaters
  )
  
  return(svg_code)
}



# Determinar el valor máximo de days_in_theaters en el dataset actual
#max_days <- max(movies_df$days_in_theaters, na.rm = TRUE)
```

```{r, function progress bar}
#| echo: false
#| include: false
generate_dynamic_progress_bar <- function(popularity_value, max_value, min_value) {
  popularity_value <- round(as.numeric(popularity_value))  # Redondear a entero

  # Escalar el valor de popularidad a un porcentaje relativo, asegurando que no supere el 100%
  percentage <- min((popularity_value - min_value*0.98) / (max_value - min_value) * 100, 100)
  
  # Formatear el número con separadores de miles
  formatted_value <- format(popularity_value, big.mark = ",", scientific = FALSE)
  
  # Generar el código HTML para la barra de progreso con el número visible
  bar_color <- ifelse(percentage > 80, "#1DB954", ifelse(percentage > 50, "#EDDE11", "#ED8E11"))
  
  bar_code <- sprintf(
    '<div style="width: 120px; height: 20px; background-color: #3A3A3A; border-radius: 5px; position: relative; display: flex; align-items: left; justify-content: flex-start;">
      <div style="width: %1$s%%; height: 100%%; background-color: %2$s; border-radius: 5px;"></div>
      <div style="position: absolute; width: 120px; text-align: left; padding-left: 5px; font-size: 12px; color: white;">%3$s</div>
    </div>',
    percentage, bar_color, formatted_value
  )
  
  return(bar_code)
}

# Determinar el valor máximo y mínimo de popularidad en el dataset actual
max_popularity <- max(movies_df$popularity, na.rm = TRUE)
min_popularity <- min(movies_df$popularity, na.rm = TRUE)
```

```{r, gt table}
#| echo: false
#| include: true
# Crear la tabla GT con la barra de progreso dinámica, las estrellas y los relojes circulares
movies_df %>%
  select(backdrop_url, original_title, days_in_theaters, vote_average, popularity) %>%
  gt::gt() %>%
  gt::cols_label(
    backdrop_url = md("**Movie**"),
    original_title = "",
    days_in_theaters = md("**Days in Theaters**"),
    vote_average = md("**Average**"),
    popularity = md("**Popularity**")
  ) %>%
  fmt_number(
    columns = c("days_in_theaters"),
    decimals = 0
  ) %>%
  text_transform(
    locations = cells_body(columns = backdrop_url),
    fn = function(x) { web_image(url = x, height = 50) }
  ) %>%
  text_transform(
    fn = function(x) {
      sapply(x, generate_clock_svg, max_days = max_days, min_days = min_days)
    },
    locations = cells_body(columns = "days_in_theaters")
  ) %>%
  text_transform(
    fn = function(x) {
      generate_star_rating(x)  # Aquí se aplica la función de estrellas
    },
    locations = cells_body(columns = "vote_average")
  ) %>%
  text_transform(
    fn = function(x) {
      sapply(x, generate_dynamic_progress_bar, max_value = max_popularity, min_value = min_popularity)
    },
    locations = cells_body(columns = "popularity")
  ) %>%
  cols_align(
    align = "center",
    columns = c("days_in_theaters", "vote_average", "popularity")
  ) %>%
  tab_options(
    table.font.color = "#FFFFFF",
    table.background.color = "#000000",
    table.font.size = px(12),
    table.border.top.color = "transparent",
    table.border.bottom.color = "transparent",
    table_body.hlines.color = "transparent",
    table_body.border.bottom.color = "transparent",
    column_labels.border.bottom.color = "transparent",
    column_labels.border.top.color = "transparent"
  )

```





## Column {width="40%"}

### Row {height="10%"}

```{r}
#| echo: false
#| include: false
# Excluir el campo genre_ids y convertir a JSON
movies_df_simplified <- movies_df %>% select(-genre_ids)  # Excluye la columna genre_ids
str(movies_df_simplified)
sapply(movies_df_simplified, class)
```


```{r, send to ojs}
#| echo: false
#| include: false
library(jsonlite)
library(dplyr)

# Convertir el dataframe simplificado a JSON y escribirlo en un archivo en la carpeta "data"
#write_json(movies_df_simplified, "data/movies_data_simplified.json")

json_data <- toJSON(movies_df_simplified, auto_unbox = TRUE, pretty = TRUE)
write(json_data, "data/movies_data_simplified.json")
```



```{ojs}
//| expandable: false

movies_df_ojs = await FileAttachment("data/movies_data_simplified.json").json()

viewof movieDropdown = Inputs.select(
  movies_df_ojs.map(d => d.original_title),
  {
    label: "Choose a movie",
    unique: true
  }
)
```

```{r, get last update}
#| echo: false
#| include: false

get_last_update <- function() {
  last_update <- Sys.time()
  return(last_update)
}

# Usar la función para obtener la última actualización
last_update <- get_last_update()
```

```{r, poner la ultima hora actualizada en el dashboard}
#| echo: false
library(htmltools)

htmltools::div(
  style = "text-align: right; font-style: italic; color: #888888; font-size: 0.8em; margin-bottom: 20px;",
  paste("Last updated:", format(last_update, "%Y-%m-%d %H:%M:%S"))
)
```


### Row {height="80%"}

```{ojs}
selectedMovie = movies_df_ojs.find(d => d.original_title === movieDropdown)

html`<div style="height: 100%; display: flex; justify-content: center; align-items: center;">
  <img src="${selectedMovie.poster_url}" 
       alt="${selectedMovie.original_title}" 
       style="max-width: 90%; 
              max-height: 100%; 
              width: auto; 
              height: auto; 
              object-fit: contain;">
</div>`
```


```{ojs}
// Mostrar estadísticas adicionales
html`<div style="margin-top: 20px;">
  <h3>${selectedMovie.original_title}</h3>
  <p>Release Date: ${selectedMovie.release_date}</p>
  <p>Average Vote: ${selectedMovie.vote_average.toFixed(2)}</p>
  <p>Vote Count: ${selectedMovie.vote_count}</p>
  <p>Popularity: ${selectedMovie.popularity.toFixed(2)}</p>
  <p>Overview: ${selectedMovie.overview}</p>
</div>`
```




### Row {height="10%"}

<div style="display: flex; justify-content: space-between; align-items: center; height: 100%; padding: 0 20px;">
  <img src="images/logo.png" alt="Creator Logo" style="height: 50px; max-width: 100%; object-fit: contain;">
  <p style="font-size: 12px; color: #666; text-align: right; margin-left: 20px;">
    Los datos son cortesía del API de tmdb.org. Los datos se extraen bajo las políticas establecidas.
  </p>
</div>